#include "cc_bn_rand.h"
#include "cc_crypto_rng.h"
#include "cc_bn_prime.h"
#include "cc_bn_convert.h"
#include "cc_rsa_core.h"
#include "cc_test.h"
#include <assert.h>
#include <stdio.h>
#include <stdlib.h>
#include <time.h>

int main()
{
    {
        cc_rsa_privkey_st privkey;
        cc_bn_t P[CC_RSA_PQ_MAX_WORDS];
        cc_bn_t Q[CC_RSA_PQ_MAX_WORDS];
        cc_bn_t DP[CC_RSA_PQ_MAX_WORDS];
        cc_bn_t DQ[CC_RSA_PQ_MAX_WORDS];
        cc_bn_t QP[CC_RSA_PQ_MAX_WORDS];

        cc_bn_t C[CC_BN_MAX_WORDS];
        cc_bn_t M[CC_BN_MAX_WORDS];
        cc_bn_t M_expect[CC_BN_MAX_WORDS];

        size_t bits = 160;
        size_t N_words = cc_bn_word_len_from_bit_len(bits);
        size_t PQ_words = cc_bn_word_len_from_bit_len(bits / 2);

        cc_bn_from_hex(P, PQ_words, "F929B553C9929D83EC8F");
        cc_bn_from_hex(Q, PQ_words, "DC1DDC1D8C5B29C9A11F");
        cc_bn_from_hex(DP, PQ_words, "63B14A7A01D705EB3905");
        cc_bn_from_hex(DQ, PQ_words, "9296BC295D78B4CA97A7");
        cc_bn_from_hex(QP, PQ_words, "C7A8D02F37FFD00D920E");

        cc_bn_from_hex(C, N_words, "BDF4B027BFCAB0C4B7B6CF693DC46ED51C331F45");
        cc_bn_from_hex(M_expect, N_words, "2BF027D5B4B911375B39E3A4487103102FF0A8A5");

        cc_rsa_set_privkey_crt(&privkey, NULL, NULL, P, Q, DP, DQ, QP, bits);

        cc_status_t ret = cc_rsa_core_private_op_crt(&privkey, C, M);
        assert(ret == CC_OK);
        print_bn("M", M, N_words);
        assert(cc_bn_cmp_words(M, M_expect, N_words) == 0);
    }
    {
        cc_rsa_privkey_st privkey;
        cc_bn_t P[CC_RSA_PQ_MAX_WORDS];
        cc_bn_t Q[CC_RSA_PQ_MAX_WORDS];
        cc_bn_t DP[CC_RSA_PQ_MAX_WORDS];
        cc_bn_t DQ[CC_RSA_PQ_MAX_WORDS];
        cc_bn_t QP[CC_RSA_PQ_MAX_WORDS];

        cc_bn_t C[CC_BN_MAX_WORDS];
        cc_bn_t M[CC_BN_MAX_WORDS];
        cc_bn_t M_expect[CC_BN_MAX_WORDS];

        size_t bits = 4096;
        size_t N_words = cc_bn_word_len_from_bit_len(bits);
        size_t PQ_words = cc_bn_word_len_from_bit_len(bits / 2);

        cc_bn_from_hex(P, PQ_words, "E2C7B7CFB473BA8D17E51F9CA436B985E1D094431219E108DBEEB42B427AC70679795F69105BAFB103090051BFA0A5EC3C44EC2B76DBA43F765FB870B93BB95100E271B14BEB5EBA00FA0AFAB0640D2334F9EA26918E0F0E81C1BD9AB93A4CCA06B44698A29ADAFE73926266573E757EDB77D36C161DF706CA275B16D10A12E3B23D7D01DCB718BBFC037FAFD9562AC792E5223B29580D10A3A23571BD00AE26CA12444A33CD7D58DEACFA35CFFC5D563FE3B66BE767D62688C0A3642E98F7478E40C673E1FA01FA39CE263265E4648D30F29BD292E73492643AB497E8A39ED7E1A1936961EE94CC9F7630E89DA223C7078DB26341F82CC15A278FA60A9F5D89");
        cc_bn_from_hex(Q, PQ_words, "D22708FDF7D2139F602783CB204F21A846AD6956F88507CD194A93D15A80BF7EDC7C03634EE7815B59B651D28CA9BAD959B1C20B42373ECA3A5880BAA006DFD06425B048939E90AC77F56963954DFC7A5ABA0720E6119E8FA146C0B0D7310B576468CCBB154C44C205B51B74DBF0040DB72DC0CF3F0FC008A4A5F008826EA266DC24178181AB9E286EC2A1774E6847A2511AF689F92ACD31E1F9F9619EC264AB27A03B22CD697A94A68DEBCA2FAE88954360666AC6EBE67FBF27C25F675EFB742CF9F1EF5E7A6B33FCD97E2AD753D400021C0ED84E84B10EA10EC4B1EC6043D3D6E1005E786D2106BE3A618BBF2E4C1D3B3F08F9276E572CD0EB99F44197C9A1");
        cc_bn_from_hex(DP, PQ_words, "06E57DF0821356E3FD8B093811425CC7F6830A4F33D8B7A03657FF00A5C7E80F8958288FA060B96A0FA6916CEAFFEEABCD75671D37431CAE9561F9D0EBC12634916B517BCBCC3F98367964261581256921AE4BF19A5190A1A74E85FE938D73525D7BD3FDC64C2146C5AAF8F515C81F789921FEBAF5BD398AEA50E213428E24DEE9C7B6EA7C94D0DABEA2389AD768286AE34BB68BC8091674A01549BCC8BBA1902A6AFDCAA7E2A2E235FB5AAC9243A16F030860BECD4DBA1477EA2BCDDB20E9BC325643F2B8378B21D9EA2BFD325E0CB4C27D4E41CC17DDE069CDE33A0F6812678C4406A098CAD1999B6BD3B6EF3C440C446D89B43D08580C153AC8C28AE627C9");
        cc_bn_from_hex(DQ, PQ_words, "1B226B28CFACD257CBC48E61D5E421C66689D186274496034776B7AB5A723147A2146923937694DF44B023D479D1188D23E5ADD662505BCD24C774A7A42DFF0C1B423A86C478BED9660BCBF5CDBB6A142A4EC6C8DAABFFBB2FE9C0CB949D828760319FEDB00C4EFC765C32155EA898FD645F85FBBC7ABE22DF8F8574B3D2B12972D73E29BCA27A236259C31B728648698EEB5A55EA543A766C65286C1061AD39E43DEE24CA3D0A54D34493E36150B9D5FC0320763D050C9806088E325F58864333E379F79C4D56363A39A2EEC92ACBBECC86EEEBC307A30CEE82C7A6E98C6C7597D3298709299E100ED3DEF07A58F1FEFC3D615D3A5826ED647467468089A6C1");
        cc_bn_from_hex(QP, PQ_words, "78F14E0CDE66992FDC31F10E36F9B1B522040D8FDF9B226894D645C5D3AF12C02D9474721C861EC8EDF3FC10C99FE6267E059326E5A11B0CD78C3A983FD96677FBDC61EDB29181F40966FE61807E36531B8D720F26994118AE4AAAA67D39077314C0C0726DE8DA25D54296D9873F0000867CA223AE72F213DA8C86437307ECA964C87B4241F86B832477F34E078AC50CCB26F74071B5202E1E3B5CF7B983DC661B7D303CA46F7848DC813842CAA469DCD47BCE204EB2F71E9201CC5EFCD438802881496D6693887AB1C19621D6F2DCA135DCE9FC102B7B5B5B5634982243619646EF4C3FA2AF662383443468046FBE471D2C6FE9CA80E90BFEB40CB255BAA938");

        cc_bn_from_hex(C, N_words, "386B9B167ACBC58A4471AF32A2B72FFDC4F2A363C20BAB62E48FAB26C4D11F25057E501E93D3A073FB6F441421413F70939ADFCCCF58D6A2DA8763CE665A9DABA0F9FF3EC67A8D55AEEF4F0DC9AE118C340E52CBC06F30BF4401C8586075BD7D2518A11E727068FA5F98F24258240F937B0F0D9D4D72E29BF0360F4F2293BD63284479A08A59AF4ADF34EE64FFD1ACA9C1EEDD7866B2E852157E2E0E0E2463CB909CB4C62C6FBF563FB4B84ABF2F7231D2C5C58E4540D21FF56E3CFC192A7ABFFE89ACF8439CF9576E3050876906217D920AAC505A4BE8B605071BD462BD956270C091B6255F4622916748E233BC1948A77BF9A8FD0B518CD4F5D1BA0E0F04FF522CBEFD74D84562AFA08225C4AD227BF1C3941306E85EEF702AD3F8DEAC483FECDE47C471EC5B9523F9A1C4056F9495D82C860616E5542372889B8BE9CA9F7CCADE0331F51BE30706348B46FD1BD7974EF8BB22745450FBDD15F92D4A08B52D083A82F9F93D21F464701B5F9995D41E0B2C29CD80480BE67F0B66FA14DC07A467712C0BB43594D2B271EE541B8457506E46FB9A333745054764BAB4F4A0B0E431E06E9419814012AEDA410E75C247A62E96C6A46DA6AC3BBDC66C5D6072825ACEB37D4C2DEE6C9F21174FBF672C014806F60B33C080AC47EDE641FDB8C49AB4A71E9A4A1BE6922B190F19CFF0015591366B98E3D44264CF79D6B6878C11B494");
        cc_bn_from_hex(M_expect, N_words, "7C5CC08DAFE56D48F5CA2CF96812B6B5B361FEBA778040A711C47EFD308226576F183D3798F39B412822D83D92C12B58612EDAF3EB0641155AE05AE7BD3DCA3D87E21887E792CCF83A2061CBB214FB7A116A0FE186BF0EEE18EB8386A0C88DCE7DB261211EAD099D75F025EF8B96FBEE1CCC08251DC1E07B862F55E52C83CA8045DB587130A959BDB7173876C93918A4318814EB21BE4E807335258922EAA8744D17B46BF35DDDF2E57FE24408D44E6041D163D9E7B25DA8B368E68D4D12A438109E91FBF2367C314AB6430C8FFAFC585A3945024474AE88311A8003545C57771581E217C287E89AA9757F6BA8FEFD7433925385E9C871A0507FE9D26A321FDD064B798261997EE82970202AC59DBC84CDB3F9531144133A5FEF0608531B1FB336B0157724904E5A45E1CA5694B263342FD66B842738A771B4C1D98D8CB3EBD8D4F3469CFCD978BBC33523DA33C606A3E2530C37E70755EE87DFE2DC128B6552DD80C893DECE22F3E752FBB36C840DEF129A68172BDD41ED747A18B9B1B163BEE2DE4D701CCCAA8B93341223B227B6CFFFACB7DAAAB5657D1A02A9A3A472F9C6AFE0CFE077D3A38BBF6CC20F1D815C1F94A3B3228BAC0184199E19AFE8627C46A5ACA6C78928BEEA838416FC5EA6375B6111AB1C4DE8EFFE946CD91CCEAF546CDEC2A8454E85506955418FF869052C7929FEE73DE562F8A1B1BAE0D827C6F401");

        cc_rsa_set_privkey_crt(&privkey, NULL, NULL, P, Q, DP, DQ, QP, bits);

        cc_status_t ret = cc_rsa_core_private_op_crt(&privkey, C, M);
        assert(ret == CC_OK);
        print_bn("M", M, N_words);
        assert(cc_bn_cmp_words(M, M_expect, N_words) == 0);
    }

    printf("all tests pass\n");
    return 0;
}